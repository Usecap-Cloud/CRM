{% extends 'base.html' %}

{% block title %}Estadísticas - USECAP CRM{% endblock %}
{% block nav_estadisticas %}active{% endblock %}

{% block extra_styles %}
<style>
    /* Premium Statistics Styles */
    .app-container-stats {
        max-width: 1000px;
        margin: 0 auto;
    }

    /* Local overrides if any, otherwise most moved to base.html */

    .stats-main-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-premium-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        padding: 24px;
        backdrop-filter: blur(10px);
        transition: transform 0.3s ease;
    }

    .stat-premium-card:hover {
        transform: translateY(-5px);
    }

    .stat-premium-card .label {
        color: #888;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
    }

    .stat-premium-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 4px;
    }

    .stat-premium-card .trend {
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .trend.up {
        color: #00ff88;
    }

    .trend.down {
        color: #ff6b6b;
    }

    .charts-section {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart-box {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 24px;
    }

    .chart-box h3 {
        font-size: 1.1rem;
        margin-bottom: 20px;
        color: #fff;
    }

    .funnel-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .funnel-stage {
        display: flex;
        align-items: center;
        height: 40px;
        border-radius: 8px;
        padding: 0 15px;
        color: #fff;
        font-size: 0.85rem;
        font-weight: 600;
        position: relative;
        overflow: hidden;
    }

    .funnel-stage::after {
        content: attr(data-value);
        position: absolute;
        right: 15px;
    }

    .stage-1 {
        background: rgba(30, 144, 255, 0.8);
        width: 100%;
    }

    .stage-2 {
        background: rgba(30, 144, 255, 0.6);
        width: 85%;
    }

    .stage-3 {
        background: rgba(30, 144, 255, 0.4);
        width: 60%;
    }

    .stage-4 {
        background: rgba(0, 255, 136, 0.5);
        width: 35%;
    }

    .ranking-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .ranking-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
    }

    .rank-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .rank-number {
        width: 24px;
        height: 24px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 700;
        color: #1e90ff;
    }

    .rank-name {
        font-weight: 500;
        color: #fff;
    }

    .rank-value {
        font-weight: 700;
        color: #1e90ff;
    }

    .loading-stats {
        text-align: center;
        padding: 50px;
        color: #1e90ff;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-title">
        <h1>Panel de Rendimiento Global</h1>
    </div>
    <div class="page-actions">
        <div class="pill-nav">
            <button class="pill-btn" onclick="updateView('semanal')" id="btn-semanal">Semanal</button>
            <button class="pill-btn active" onclick="updateView('mensual')" id="btn-mensual">Mensual</button>
            <button class="pill-btn" onclick="updateView('anual')" id="btn-anual">Anual</button>
        </div>
    </div>
</div>

<div class="app-container-stats">

    <div id="loading-stats" class="loading-stats">Cargando métricas de rendimiento...</div>

    <div id="content-stats" style="display: none;">
        <!-- KPI Cards -->
        <div class="stats-main-grid">
            <div class="stat-premium-card">
                <div class="label">Ingresos Totales</div>
                <div class="value" id="kpi-ingresos">$0</div>
                <div class="trend up" id="trend-ingresos">↑ 12.5% vs prev</div>
            </div>
            <div class="stat-premium-card">
                <div class="label">Contratos Cerrados</div>
                <div class="value" id="kpi-contratos">0</div>
                <div class="trend up" id="trend-contratos">↑ 8.2% vs prev</div>
            </div>
            <div class="stat-premium-card">
                <div class="label">Tasa de Conversión</div>
                <div class="value" id="kpi-conversion">0%</div>
                <div class="trend down" id="trend-conversion">↓ 1.4% vs prev</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-box">
                <h3>Tendencia de Ventas</h3>
                <canvas id="salesChart" height="200"></canvas>
            </div>
            <div class="chart-box">
                <h3>Embudo de Ventas (Conversión)</h3>
                <div class="funnel-container">
                    <div class="funnel-stage stage-1" id="funnel-1" data-value="0">Prospectos</div>
                    <div class="funnel-stage stage-2" id="funnel-2" data-value="0">Negociación</div>
                    <div class="funnel-stage stage-3" id="funnel-3" data-value="0">Propuesta</div>
                    <div class="funnel-stage stage-4" id="funnel-4" data-value="0">Cierre</div>
                </div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-box">
                <h3>Distribución por Servicio</h3>
                <canvas id="serviceChart" height="200"></canvas>
            </div>
            <div class="chart-box">
                <h3>Ranking de Ejecutivos</h3>
                <div class="ranking-list" id="exec-ranking"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let salesChart, serviceChart;
    let cachedStats = null;
    let cachedPortfolio = null;

    async function loadInitialData() {
        try {
            const statsRes = await fetch('/api/dashboard-stats/');
            if (!statsRes.ok) throw new Error(`Status ${statsRes.status} on stats`);
            cachedStats = await statsRes.json();

            const portfolioRes = await fetch('/api/portfolio-data/');
            if (!portfolioRes.ok) throw new Error(`Status ${portfolioRes.status} on portfolio`);
            cachedPortfolio = await portfolioRes.json();

            if (!Array.isArray(cachedPortfolio)) {
                console.error('Portfolio data is not an array:', cachedPortfolio);
                cachedPortfolio = [];
            }

            document.getElementById('loading-stats').style.display = 'none';
            document.getElementById('content-stats').style.display = 'block';

            updateView('mensual');
        } catch (error) {
            document.getElementById('loading-stats').style.color = '#ff6b6b';
            document.getElementById('loading-stats').textContent = 'Error: No se pudieron cargar los datos. Reintente en unos momentos.';
            console.error('Initial load failed:', error);
        }
    }

    function updateView(period) {
        // Update tabs
        document.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + period).classList.add('active');

        // Multipliers/Logic for simulation based on period
        let mult = 1;
        if (period === 'semanal') mult = 0.25;
        if (period === 'anual') mult = 8.5;

        // Update KPIs
        const totalEmpresas = (cachedStats.empresas_activas || 0);
        document.getElementById('kpi-ingresos').textContent = '$' + (totalEmpresas * mult * 1.2).toFixed(1) + 'M';
        document.getElementById('kpi-contratos').textContent = Math.floor(totalEmpresas * mult * 0.8);
        document.getElementById('kpi-conversion').textContent = (65 + (mult * 2)).toFixed(1) + '%';

        // Update Funnel
        document.getElementById('funnel-1').setAttribute('data-value', Math.floor(200 * mult));
        document.getElementById('funnel-2').setAttribute('data-value', Math.floor(140 * mult));
        document.getElementById('funnel-3').setAttribute('data-value', Math.floor(90 * mult));
        document.getElementById('funnel-4').setAttribute('data-value', Math.floor(45 * mult));

        // Update Charts
        updateCharts(period, mult);
        updateRanking(mult);
    }

    function updateCharts(period, mult) {
        const labels = period === 'semanal' ? ['Lun', 'Mar', 'Mie', 'Jue', 'Vie'] :
            period === 'anual' ? ['Q1', 'Q2', 'Q3', 'Q4'] : ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];

        const data = labels.map(() => Math.floor(Math.random() * 50 * mult) + 20);

        if (salesChart) salesChart.destroy();
        const ctx = document.getElementById('salesChart').getContext('2d');
        salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ventas',
                    data: data,
                    borderColor: '#1e90ff',
                    backgroundColor: 'rgba(30, 144, 255, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });

        if (serviceChart) serviceChart.destroy();
        const sCtx = document.getElementById('serviceChart').getContext('2d');
        serviceChart = new Chart(sCtx, {
            type: 'doughnut',
            data: {
                labels: ['SENCE', 'Privado', 'Convenio'],
                datasets: [{
                    data: [40, 35, 25],
                    backgroundColor: ['#1e90ff', '#00ff88', '#ff9f43'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                cutout: '70%',
                plugins: { legend: { position: 'bottom', labels: { color: '#888' } } }
            }
        });
    }

    function updateRanking(mult) {
        const ranking = document.getElementById('exec-ranking');
        if (!cachedPortfolio || cachedPortfolio.length === 0) {
            ranking.innerHTML = '<p style="color:#666; text-align:center;">No hay datos disponibles</p>';
            return;
        }

        const sorted = [...cachedPortfolio].sort((a, b) => b.total_clientes - a.total_clientes).slice(0, 5);

        ranking.innerHTML = sorted.map((ej, i) => `
            <div class="ranking-item">
                <div class="rank-info">
                    <div class="rank-number">${i + 1}</div>
                    <div class="rank-name">${ej.ejecutivo_nombre}</div>
                </div>
                <div class="rank-value">${Math.floor(ej.total_clientes * mult * 1.5)} pts</div>
            </div>
        `).join('');
    }

    loadInitialData();
</script>
{% endblock %}