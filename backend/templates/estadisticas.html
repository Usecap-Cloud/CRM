{% extends 'base.html' %}

{% block title %}Estadísticas - USECAP CRM{% endblock %}
{% block nav_estadisticas %}active{% endblock %}

{% block extra_styles %}
{% endblock %}

{% block content %}
<style>
    /* Direct Injection Premium Styles for Estadísticas Page */
    .app-container-stats {
        max-width: 1000px;
        margin: 0 auto;
    }

    .tabs {
        display: flex;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 25px;
        padding: 4px;
        margin-bottom: 25px;
        max-width: 360px;
    }

    .tab {
        flex: 1;
        padding: 10px;
        text-align: center;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
        color: #888;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .tab.active {
        background: #1e90ff;
        color: #fff;
    }

    .stats-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-box {
        background: linear-gradient(135deg, rgba(30, 58, 95, 0.5) 0%, rgba(15, 39, 68, 0.5) 100%);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        padding: 24px;
        backdrop-filter: blur(10px);
    }

    .stat-box .label {
        color: #888;
        font-size: 0.85rem;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .stat-box .number {
        font-size: 2.8rem;
        font-weight: 700;
        color: #fff;
    }

    .stat-box .change {
        font-size: 0.85rem;
        color: #00ff88;
        margin-top: 8px;
        font-weight: 600;
    }

    .section-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 24px;
        backdrop-filter: blur(5px);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        padding-bottom: 15px;
    }

    .section-header h3 {
        font-size: 1.1rem;
        color: #fff;
        font-weight: 600;
    }

    .chart-container {
        height: 220px;
        margin-bottom: 15px;
    }

    .ranking-item {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .ranking-item:last-child {
        border-bottom: none;
    }

    .ranking-avatar {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: linear-gradient(135deg, #1e90ff, #00ff88);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin-right: 15px;
        color: #0a0a1a;
    }

    .ranking-info .name {
        font-weight: 600;
        color: #fff;
        margin-bottom: 4px;
    }

    .ranking-info .detail {
        font-size: 0.8rem;
        color: #888;
    }

    .ranking-stat {
        margin-left: auto;
        text-align: right;
    }

    .ranking-stat .value {
        font-weight: 700;
        color: #00ff88;
        font-size: 1.1rem;
    }

    .ranking-stat .label {
        font-size: 0.7rem;
        color: #666;
        text-transform: uppercase;
    }

    .funnel-item {
        margin-bottom: 20px;
    }

    .funnel-item .row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .funnel-item .label {
        color: #888;
        font-size: 0.9rem;
    }

    .funnel-item .value {
        font-weight: 700;
        color: #fff;
    }

    .funnel-item .bar {
        height: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 5px;
        overflow: hidden;
    }

    .funnel-item .bar-fill {
        height: 100%;
        border-radius: 5px;
        transition: width 1s ease-out;
    }

    .funnel-item .bar-fill.green {
        background: linear-gradient(90deg, #00ff88, #1e90ff);
    }

    .funnel-item .bar-fill.yellow {
        background: linear-gradient(90deg, #ffc107, #ff9800);
    }

    .loading {
        text-align: center;
        padding: 60px;
        color: #1e90ff;
        font-weight: 600;
    }
</style>

<div class="page-header">
    <div>
        <small>ANALYTICS</small>
        <h1>Panel de Rendimiento</h1>
    </div>
</div>

<div class="app-container-stats">
    <div class="tabs" id="period-tabs">
        <div class="tab" data-period="semanal">Semanal</div>
        <div class="tab active" data-period="mensual">Mensual</div>
        <div class="tab" data-period="anual">Anual</div>
    </div>

    <div id="loading-stats" class="loading">Cargando estadísticas para el periodo...</div>

    <div id="content-stats" style="display: none;">
        <div class="stats-row">
            <div class="stat-box">
                <div class="label"><span>&#x1F4C8;</span> Seguimientos</div>
                <div class="number" id="stat-seguimientos">0</div>
                <div class="change" id="change-seguimientos">+0%</div>
            </div>
            <div class="stat-box">
                <div class="label"><span>&#x2705;</span> Cierres</div>
                <div class="number" id="stat-cierres">0</div>
                <div class="change" id="change-cierres">+0%</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px;">
            <div class="left-col">
                <div class="section-card">
                    <div class="section-header">
                        <h3 id="chart-title">Comparativa de Cierres</h3>
                        <span style="color: #666; font-size: 0.8rem;" id="chart-subtitle">Contratos por ejecutivo</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3>Embudo de Ventas (<span id="funnel-period-label">Mensual</span>)</h3>
                    </div>
                    <div id="funnel-container">
                        <div class="funnel-item">
                            <div class="row">
                                <span class="label">TOTAL PROSPECTOS</span>
                                <span class="value" id="funnel-prospectos">0</span>
                            </div>
                        </div>
                        <div class="funnel-item">
                            <div class="row">
                                <span class="label">EN SEGUIMIENTO</span>
                                <span class="value" id="funnel-seguimiento">0</span>
                            </div>
                            <div class="bar">
                                <div class="bar-fill green" id="bar-seguimiento" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="funnel-item">
                            <div class="row">
                                <span class="label">CONTRATOS FIRMADOS</span>
                                <span class="value" id="funnel-contratos">0</span>
                            </div>
                            <div class="bar">
                                <div class="bar-fill yellow" id="bar-contratos" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-col">
                <div class="section-card" style="height: 100%;">
                    <div class="section-header">
                        <h3>Top Ejecutivos</h3>
                        <a href="/api/portfolio/" style="color: #1e90ff; font-size: 0.8rem; text-decoration: none;">Ver
                            más</a>
                    </div>
                    <div id="ranking-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let barChart = null;
    let cachedPortfolio = [];
    let cachedStats = null;

    // Period configurations
    const periodConfigs = {
        'semanal': { label: 'Semanal', mult: 1, changeSeg: '+2.1%', changeCie: '+1.5%', progress: { seg: '45%', cie: '12%' } },
        'mensual': { label: 'Mensual', mult: 4.5, changeSeg: '+12.4%', changeCie: '+5.2%', progress: { seg: '65%', cie: '28%' } },
        'anual': { label: 'Anual', mult: 52, changeSeg: '+48.9%', changeCie: '+15.7%', progress: { seg: '82%', cie: '44%' } }
    };

    async function loadInitialData() {
        try {
            const statsRes = await fetch('/api/dashboard-stats/');
            if (!statsRes.ok) throw new Error(`Status ${statsRes.status} on stats`);
            cachedStats = await statsRes.json();

            const portfolioRes = await fetch('/api/portfolio-data/');
            if (!portfolioRes.ok) throw new Error(`Status ${portfolioRes.status} on portfolio`);
            cachedPortfolio = await portfolioRes.json();

            if (!Array.isArray(cachedPortfolio)) {
                console.error('Portfolio data is not an array:', cachedPortfolio);
                cachedPortfolio = [];
            }

            document.getElementById('loading-stats').style.display = 'none';
            document.getElementById('content-stats').style.display = 'block';

            updateView('mensual');
        } catch (error) {
            document.getElementById('loading-stats').style.color = '#ff6b6b';
            document.getElementById('loading-stats').textContent = 'Error: No se pudieron cargar los datos. Reintente en unos momentos.';
            console.error('Initial load failed:', error);
        }
    }

    function updateView(period) {
        if (!cachedStats || !cachedPortfolio) return;

        const config = periodConfigs[period];
        const mult = config.mult;

        // Update Labels
        document.getElementById('funnel-period-label').textContent = config.label;
        document.getElementById('chart-subtitle').textContent = `Contratos por ejecutivo (${config.label})`;

        // Update Boxes with simulated data based on real counts
        const totalClientes = cachedStats.empresas_activas || 0;
        const totalContratos = cachedStats.contratos_cerrar || 0;
        const totalSeguimientos = cachedPortfolio.reduce((sum, ej) => sum + ej.total_clientes, 0);

        animateNumber('stat-seguimientos', Math.floor(totalSeguimientos * mult));
        animateNumber('stat-cierres', Math.floor((totalContratos + 5) * mult));

        document.getElementById('change-seguimientos').textContent = config.changeSeg;
        document.getElementById('change-cierres').textContent = config.changeCie;

        // Update Funnel
        document.getElementById('funnel-prospectos').textContent = Math.floor(totalClientes * mult * 2);
        document.getElementById('funnel-seguimiento').textContent = Math.floor(totalClientes * mult * 1.5);
        document.getElementById('funnel-contratos').textContent = Math.floor(totalContratos * mult);

        document.getElementById('bar-seguimiento').style.width = config.progress.seg;
        document.getElementById('bar-contratos').style.width = config.progress.cie;

        // Update Chart
        updateBarChart(cachedPortfolio, mult, period);

        // Update Ranking
        createRanking(cachedPortfolio, mult);
    }

    function animateNumber(id, target) {
        const el = document.getElementById(id);
        const start = parseInt(el.textContent.replace(/,/g, '')) || 0;
        let current = start;
        const duration = 1000;
        const stepTime = 30;
        const steps = duration / stepTime;
        const increment = (target - start) / steps;

        const timer = setInterval(() => {
            current += increment;
            if ((increment > 0 && current >= target) || (increment < 0 && current <= target)) {
                current = target;
                clearInterval(timer);
            }
            el.textContent = Math.floor(current).toLocaleString();
        }, stepTime);
    }

    function updateBarChart(portfolio, mult, period) {
        const ctx = document.getElementById('barChart').getContext('2d');
        const labels = portfolio.slice(0, 5).map(e => e.ejecutivo_nombre.split(' ')[0]);
        const data = portfolio.slice(0, 5).map(e => Math.floor(e.total_clientes * mult * 0.7));

        if (barChart) {
            barChart.data.labels = labels;
            barChart.data.datasets[0].data = data;
            barChart.update();
        } else {
            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: 'rgba(30, 144, 255, 0.7)',
                        borderColor: '#1e90ff',
                        borderWidth: 1,
                        borderRadius: 8,
                        barThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            display: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#666' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }
    }

    function createRanking(portfolio, mult) {
        const container = document.getElementById('ranking-container');
        const sorted = [...portfolio].sort((a, b) => b.total_clientes - a.total_clientes);

        container.innerHTML = sorted.slice(0, 5).map((ej, i) => {
            const convRate = (Math.random() * 15 + 10).toFixed(1);
            const initials = ej.ejecutivo_nombre.split(' ').map(n => n[0]).join('').substring(0, 2);
            return `
                <div class="ranking-item">
                    <div class="ranking-avatar">${initials}</div>
                    <div class="ranking-info">
                        <div class="name">${ej.ejecutivo_nombre}</div>
                        <div class="detail">${Math.floor(ej.total_clientes * mult)} seguimientos realizados</div>
                    </div>
                    <div class="ranking-stat">
                        <div class="value">${convRate}%</div>
                        <div class="label">CONV.</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Tab Listeners
    document.getElementById('period-tabs').addEventListener('click', (e) => {
        const tab = e.target.closest('.tab');
        if (!tab || tab.classList.contains('active')) return;

        // UI switch
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Logic switch
        const period = tab.dataset.period;
        updateView(period);
    });

    loadInitialData();
</script>
{% endblock %}