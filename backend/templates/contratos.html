{% extends 'base.html' %}

{% block title %}Contratos Operativos - USECAP CRM{% endblock %}
{% block nav_contratos %}active{% endblock %}

{% block extra_styles %}
<style>
    /* Premium Styles for Contratos Page */
    /* Premium Styles for Contratos Page */
    .page-actions {
        display: flex;
        gap: 12px;
    }

    /* Fix Date Picker Icon */

    /* Fix Date Picker Icon */
    input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
        filter: invert(53%) sepia(92%) saturate(1556%) hue-rotate(193deg) brightness(103%) contrast(101%);
    }

    .contratos-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .contratos-table th {
        color: #888;
        font-weight: 500;
        font-size: 0.85rem;
        padding: 15px;
        text-align: left;
    }

    .contratos-table td {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
    }


    /* Form Page Styles */
    #form-view {
        display: none;
        background: var(--bg-color);
        max-width: 900px;
        margin: 0 auto;
    }

    #form-view.active {
        display: block;
    }

    .form-header {
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
    }

    .form-header .back-btn {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .form-body {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 24px;
        padding: 40px;
        backdrop-filter: blur(8px);
    }

    .form-row {
        display: flex;
        gap: 24px;
        margin-bottom: 24px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
    }

    .form-group label {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 12px 16px;
        color: var(--text-color);
        width: 100%;
    }

    .form-group input:focus {
        border-color: #1e90ff;
        outline: none;
    }

    /* Accordion Aesthetic Styles */
    .main-row {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .main-row:hover {
        background: rgba(30, 144, 255, 0.05) !important;
    }
    .main-row.active {
        background: rgba(30, 144, 255, 0.08) !important;
        border-left: 4px solid #1e90ff;
    }
    .detail-row td {
        background: var(--bg-color) !important;
        padding: 0 !important;
    }
    .detail-container {
        padding: 0 40px;
        max-height: 0;
        overflow: hidden;
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        border-bottom: 2px solid transparent;
        opacity: 0;
    }
    .detail-container.show {
        padding: 25px 40px;
        max-height: 1000px; /* Allow expansion */
        border-bottom-color: var(--border-color);
        opacity: 1;
    }
    .detail-section {
        padding: 20px;
        background: var(--sidebar-bg);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 12px rgba(0,0,0,0.02);
        transition: all 0.3s ease;
    }
    .detail-section:hover {
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .contratos-table th {
        text-transform: capitalize;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<!-- List View -->
<div id="list-view">
    <div class="page-header">
        <div class="header-title">
            <h1>Contratos</h1>
        </div>
        <div class="page-actions">
            <div class="pill-nav">
                <button class="pill-btn primary" onclick="showForm()"><span>&#x002B;</span> Nuevo Contrato</button>
            </div>
        </div>
    </div>

    <div id="alert" class="alert" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>

    <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="Buscar por Empresa, Ejecutivo, Estado, Fechas..." onkeyup="filterTable('search-input', 'contratos-table')">
    </div>

    <div class="card">
        <div id="loading" style="text-align: center; padding: 50px; color: #888;">Buscando Contratos Operativos...</div>
        <div id="no-data" style="text-align: center; padding: 50px; color: #888; display: none;">No hay información
            disponible</div>
        <table class="contratos-table" id="contratos-table" style="display: none;">
            <thead>
                <tr>
                    <th style="width: 40px;"></th>
                    <th>Empresa</th>
                    <th>Facturación</th>
                    <th>RUS</th>
                    <th>Estado</th>
                    <th>Seguimiento</th>
                    <th style="text-align: right;"></th>
                </tr>
            </thead>
            <tbody id="contratos-body"></tbody>
        </table>
    </div>
</div>

<!-- Form View -->
<div class="form-page" id="form-view">
    <div class="form-header">
        <button class="back-btn" onclick="hideForm()">&#x2190;</button>
        <h2 id="form-title">Nuevo Contrato</h2>
    </div>
    <div class="form-body">
        <form id="contrato-form" onsubmit="saveContrato(event)">
            <input type="hidden" name="id" id="contrato-id">
            <div class="form-row">
                <div class="form-group">
                    <label>Empresa</label>
                    <select name="empresa" id="empresa-select" required>
                        <option value="">Seleccionar empresa...</option>
                    </select>
                    <div id="razon-social-warning" style="display:none; margin-top: 8px; padding: 10px; background: rgba(255,165,0,0.1); border: 1px solid orange; color: #d9480f; border-radius: 8px; font-size: 0.8rem;">
                        ⚠️ <strong>Atención:</strong> Esta empresa no tiene <b>Razón Social</b> registrada. Es necesaria para formalizar el contrato.
                    </div>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select name="estado" id="form-estado" required>
                        <option value="aprobado">Aprobado (Pasar a Propuestas)</option>
                        <option value="rechazado">Rechazado (Pasar a Propuestas)</option>
                        <option value="en proceso">En Proceso</option>
                        <option value="liquidado">Liquidado</option>
                        <option value="finalizado">Finalizado</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Ejecutivo Responsable</label>
                    <select name="ejecutivo" id="ejecutivo-select" required>
                        <option value="">Seleccionar ejecutivo...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Encargado</label>
                    <select name="coordinador" id="encargado-select" required>
                        <option value="">No asignado</option>
                    </select>
                </div>
            </div>

            <div class="form-row" style="background: rgba(30,144,255,0.02); padding: 20px; border-radius: 12px; border: 1px dashed var(--border-color); margin-bottom: 24px;">
                <div style="width: 100%;">
                    <h4 style="font-size: 0.8rem; color: #1e90ff; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        &#x2699; Información del Curso (En tabla Contratos)
                    </h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Orden de Compra (OC)</label>
                            <input type="text" name="orden_compra" id="form-orden_compra" placeholder="OC-XXXX">
                        </div>
                        <div class="form-group">
                            <label>Número Factura</label>
                            <input type="text" name="numero_factura" id="form-numero_factura" placeholder="0001">
                        </div>
                        <div class="form-group">
                            <label>RUS</label>
                            <input type="text" name="rus" id="form-rus" placeholder="RUS-XXXX">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Relator</label>
                            <input type="text" name="relator" id="form-relator" placeholder="Nombre del relator">
                        </div>
                        <div class="form-group">
                            <label>Modalidad</label>
                            <select name="modalidad" id="form-modalidad">
                                <option value="E-learning">E-learning</option>
                                <option value="Presencial">Presencial</option>
                                <option value="Mixta">Mixta</option>
                                <option value="Sincrónica">Sincrónica</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha Inicio Curso</label>
                            <input type="date" name="fecha_inicio_curso" id="form-fecha_inicio_curso">
                        </div>
                        <div class="form-group">
                            <label>Fecha Fin Curso</label>
                            <input type="date" name="fecha_fin_curso" id="form-fecha_fin_curso">
                        </div>
                        <div class="form-group">
                            <label>Horas</label>
                            <input type="number" name="duracion_horas" id="form-duracion_horas" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Participantes</label>
                            <input type="number" name="numero_participantes" id="form-numero_participantes" placeholder="0">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Curso</label>
                    <select name="curso" id="curso-select">
                        <option value="">Seleccionar curso...</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Servicios (Selección Múltiple)</label>
                    <select name="servicios" id="servicios-select" multiple 
                            style="height: 120px; border: 2px solid var(--border-color); border-radius: 12px; padding: 10px; font-size: 0.8rem; cursor: pointer;"
                            onchange="checkOtrosServicio()">
                    </select>
                    <small style="color: var(--text-muted); font-size: 0.65rem;">Mantén presionada la tecla Ctrl (Cmd en Mac) para seleccionar varios</small>

                    <!-- Detalle para 'Otros' -->
                    <div id="otro-servicio-container" style="display: none; margin-top: 15px; padding: 15px; background: rgba(30,144,255,0.05); border-radius: 12px; border: 1px dashed #1e90ff;">
                        <label style="font-size: 0.75rem; color: #1e90ff; font-weight: 700; margin-bottom: 8px; display: block;">Detalle de Nuevo Servicio</label>
                        <input type="text" id="form-otro_servicio" name="otro_servicio" placeholder="Ej: Consultoría en IA, Soporte 24/7..." 
                               style="background: #fff; border: 1px solid #1e90ff;">
                    </div>
                </div>
            </div>

            <!-- Costos y Proveedores por Servicio -->
            <div id="proveedores-costos-container" style="margin-bottom: 24px;">
                <h4 style="font-size: 0.8rem; color: #1e90ff; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    Asignación de Costos y Proveedores
                </h4>
                <div id="servicios-items-list" style="display: grid; gap: 12px;">
                    <!-- Se llenará dinámicamente -->
                </div>
                <div id="no-servicios-msg" style="text-align: center; padding: 20px; border: 1px dashed var(--border-color); border-radius: 12px; color: var(--text-muted); font-size: 0.8rem;">
                    Seleccione servicios arriba para asignar proveedores y costos
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Tipo de Convenio</label>
                    <select name="tipo_convenio" id="form-tipo_convenio">
                        <option value="Particular">Particular</option>
                        <option value="OTIC">OTIC</option>
                        <option value="SENCE">SENCE</option>
                    </select>
                </div>
            </div>

            <div class="form-actions"
                style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px; padding-top: 30px; border-top: 1px solid var(--border-color);">
                <button type="button" class="btn btn-secondary" onclick="hideForm()">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="submit-btn">Crear Contrato</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleAccordion(id) {
        const detailRow = document.getElementById(`detail-${id}`);
        const container = detailRow.querySelector('.detail-container');
        const icon = document.getElementById(`icon-${id}`);
        const isVisible = container.classList.contains('show');

        if (isVisible) {
            container.classList.remove('show');
            setTimeout(() => { if (!container.classList.contains('show')) detailRow.style.display = 'none'; }, 350);
            icon.style.transform = 'rotate(0deg)';
            detailRow.closest('tr').previousElementSibling.classList.remove('active');
        } else {
            detailRow.style.display = 'table-row';
            setTimeout(() => container.classList.add('show'), 10);
            icon.style.transform = 'rotate(90deg)';
            detailRow.closest('tr').previousElementSibling.classList.add('active');
        }
    }

    let currentContratos = [];


    function showForm(data = null) {
        document.getElementById('list-view').style.display = 'none';
        document.getElementById('form-view').classList.add('active');
        
        // Reset multi-selects
        ['servicios-select', 'proveedores-select'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                Array.from(select.options).forEach(opt => opt.selected = false);
            }
        });
        const serviciosSelect = document.getElementById('servicios-select');
        if (serviciosSelect) {
            Array.from(serviciosSelect.options).forEach(opt => opt.selected = false);
        }
        document.getElementById('otro-servicio-container').style.display = 'none';
        document.getElementById('form-otro_servicio').value = '';
        document.getElementById('servicios-items-list').innerHTML = '';
        document.getElementById('no-servicios-msg').style.display = 'block';
    

        if (data) {
            document.getElementById('form-title').textContent = 'Editar Contrato';
            document.getElementById('contrato-id').value = data.id;
            document.getElementById('empresa-select').value = data.cliente;
            document.getElementById('form-estado').value = data.estado;
            document.getElementById('form-tipo_convenio').value = data.tipo_convenio || 'Particular';
            document.getElementById('curso-select').value = data.curso || '';

            // Populate Operativo Data (from first ContratoCurso)
            const op = (data.contratocurso_set && data.contratocurso_set.length > 0) ? data.contratocurso_set[0] : {};
            document.getElementById('form-orden_compra').value = op.orden_compra || '';
            document.getElementById('form-numero_factura').value = op.numero_factura || '';
            document.getElementById('form-rus').value = op.rus || '';
            document.getElementById('form-relator').value = op.relator || '';
            document.getElementById('form-modalidad').value = op.modalidad || 'E-learning';
            document.getElementById('form-fecha_inicio_curso').value = op.fecha_inicio_curso || '';
            document.getElementById('form-fecha_fin_curso').value = op.fecha_fin_curso || '';
            document.getElementById('form-duracion_horas').value = op.duracion_horas || 0;
            document.getElementById('form-numero_participantes').value = op.numero_participantes || 0;
            

            // Handle Multi-selects
            if (data.servicios) {
                data.servicios.forEach(id => {
                    const opt = document.querySelector(`#servicios-select option[value="${id}"]`);
                    if (opt) opt.selected = true;
                });
            }
            if (data.otro_servicio) {
                const otrosOpt = document.querySelector('#servicios-select option[value="otros"]');
                if (otrosOpt) otrosOpt.selected = true;
                document.getElementById('form-otro_servicio').value = data.otro_servicio;
                document.getElementById('otro-servicio-container').style.display = 'block';
            }
            if (data.proveedores) {
                data.proveedores.forEach(id => {
                    const opt = document.querySelector(`#proveedores-select option[value="${id}"]`);
                    if (opt) opt.selected = true;
                });
            }

            document.getElementById('submit-btn').textContent = 'Actualizar Contrato';
        } else {
            document.getElementById('form-title').textContent = 'Nuevo Contrato';
            document.getElementById('contrato-id').value = '';
            document.getElementById('contrato-form').reset();
            document.getElementById('form-valor_persona').value = 0;
            document.getElementById('form-valor_total').value = 0;
            document.getElementById('form-pago_otic').value = 0;
            document.getElementById('form-pago_empresa').value = 0;
            document.getElementById('submit-btn').textContent = 'Crear Contrato';
        }

        // Always sync the cost rows after setting data
        updateServiceCostRows(data);
    }

    let allProveedores = [];
    async function getProveedoresList() {
        if (allProveedores.length > 0) return allProveedores;
        try {
            const response = await fetch('/api/proveedores/');
            const data = await response.json();
            allProveedores = Array.isArray(data) ? data : (data.results || []);
            return allProveedores;
        } catch (e) { return []; }
    }

    async function updateServiceCostRows(data = null) {
        const select = document.getElementById('servicios-select');
        const list = document.getElementById('servicios-items-list');
        const msg = document.getElementById('no-servicios-msg');
        
        const selectedOptions = Array.from(select.options).filter(opt => opt.selected && opt.value !== 'others');
        
        if (selectedOptions.length === 0) {
            list.innerHTML = '';
            msg.style.display = 'block';
            return;
        }
        
        msg.style.display = 'none';
        const proveedores = await getProveedoresList();
        
        // Keep track of existing values in the DOM to not lose them on re-render if possible
        const currentVals = {};
        list.querySelectorAll('.service-cost-row').forEach(row => {
            const sid = row.dataset.servicioId;
            currentVals[sid] = {
                prov: row.querySelector('.prov-sel').value,
                cost: row.querySelector('.cost-inp').value
            };
        });

        list.innerHTML = '';
        selectedOptions.forEach(opt => {
            const sid = opt.value;
            const sname = opt.textContent;
            
            // Check if we have data from the database (edit mode)
            let dbProv = "";
            let dbCost = "";
            if (data && data.contratoproveedor_set) {
                const match = data.contratoproveedor_set.find(cp => cp.servicio == sid);
                if (match) {
                    dbProv = match.proveedor;
                    dbCost = match.costo_negociado;
                }
            }
            
            const saved = currentVals[sid] || { prov: dbProv, cost: dbCost };

            const row = document.createElement('div');
            row.className = 'service-cost-row';
            row.dataset.servicioId = sid;
            row.style = "display: grid; grid-template-columns: 1fr 1fr 120px; gap: 15px; align-items: flex-end; padding: 12px; background: #fff; border: 1px solid var(--border-color); border-radius: 10px; border-left: 4px solid #1e90ff;";
            
            row.innerHTML = `
                <div>
                    <label style="font-size: 0.65rem; color: var(--text-muted); margin-bottom: 4px; display: block;">Servicio</label>
                    <div style="font-size: 0.8rem; font-weight: 600;">${sname}</div>
                </div>
                <div>
                    <label style="font-size: 0.65rem; color: var(--text-muted); margin-bottom: 4px; display: block;">Proveedor</label>
                    <select class="prov-sel" style="padding: 6px; font-size: 0.8rem; border-radius: 6px;" onchange="checkOtroProv(this)">
                        <option value="">Seleccionar...</option>
                        ${proveedores.map(p => `<option value="${p.id}" ${p.id == saved.prov ? 'selected' : ''}>${p.nombre}</option>`).join('')}
                        <option value="otros" ${saved.prov == 'otros' ? 'selected' : ''} style="color:#1e90ff;">OTRO</option>
                    </select>
                    <!-- Detalle para nuevo proveedor -->
                    <input type="text" class="otro-prov-inp" value="${saved.otro || ''}" 
                           placeholder="Nombre del nuevo proveedor" 
                           style="display: ${saved.prov == 'otros' ? 'block' : 'none'}; margin-top: 8px; padding: 6px; font-size: 0.75rem; border-radius: 6px; border: 1px solid #1e90ff; width: 100%;">
                </div>
                <div>
                    <label style="font-size: 0.65rem; color: var(--text-muted); margin-bottom: 4px; display: block;">Costo Negociado</label>
                    <input type="number" class="cost-inp" value="${saved.cost}" placeholder="0" style="padding: 6px; font-size: 0.8rem; border-radius: 6px;">
                </div>
            `;
            list.appendChild(row);
        });
    }

    function checkOtroProv(select) {
        const inp = select.nextElementSibling;
        if (inp && inp.classList.contains('otro-prov-inp')) {
            inp.style.display = select.value === 'otros' ? 'block' : 'none';
        }
    }

    function hideForm() {
        document.getElementById('list-view').style.display = 'block';
        document.getElementById('form-view').classList.remove('active');
        document.getElementById('contrato-form').reset();
    }

    async function loadContratos() {
        try {
            const response = await fetch('/api/contratos/');
            const data = await response.json();
            currentContratos = Array.isArray(data) ? data : (data.results || []);
            document.getElementById('loading').style.display = 'none';

            if (currentContratos.length === 0) {
                document.getElementById('no-data').style.display = 'block';
                document.getElementById('contratos-table').style.display = 'none';
            } else {
                document.getElementById('no-data').style.display = 'none';
                document.getElementById('contratos-table').style.display = 'table';
                const tbody = document.getElementById('contratos-body');
                
                tbody.innerHTML = currentContratos.map(c => {
                    const clean = (val) => {
                        if (val === null || val === undefined || val.toString().toLowerCase() === 'nan' || val.toString().toLowerCase() === 'none') return '-';
                        return val;
                    };
                    const cap = (val) => {
                        if (!val || typeof val !== 'string') return val;
                        const s = val.trim();
                        return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
                    };
                    const fmtCur = (val) => val ? `$${parseFloat(val).toLocaleString('es-CL').replace(/,/g, '.')}` : '$0';
                    
                    // Get first ContratoCurso for main table display
                    const op = (c.contratocurso_set && c.contratocurso_set.length > 0) ? c.contratocurso_set[0] : {};
                    
                    const pendingSegs = (c.seguimientos_info || []).filter(s => !s.cerrado);
                    const nextSeg = pendingSegs.length > 0 
                        ? pendingSegs.sort((a,b) => new Date(a.fecha_seguimiento || a.fecha) - new Date(b.fecha_seguimiento || b.fecha))[0]
                        : null;
                    const nextSegDate = nextSeg ? (nextSeg.fecha_seguimiento || nextSeg.fecha) : '-';
                    
                    const estadoClass = c.estado && (c.estado.toLowerCase().includes('proceso') || c.estado.toLowerCase().includes('aprobado')) ? 'active' : 
                                       (c.estado && (c.estado.toLowerCase().includes('nuevo') || c.estado.toLowerCase().includes('liquidado')) ? 'warning' : '');
                    
                    return `
                    <tr class="main-row" onclick="toggleAccordion(${c.id})">
                        <td style="text-align: center; color: #1e90ff;">
                            <span id="icon-${c.id}">&#x25B8;</span>
                        </td>
                        <td>
                            <div style="font-weight: 800; color: #1e90ff; font-size: 0.75rem; margin-bottom: 2px;">${clean(c.folio)}</div>
                            <div class="td-main">${clean(c.empresa_nombre || c.empresa)}</div>
                        </td>
                        <td>
                            <div class="td-main">${clean(op.orden_compra)}</div>
                            <div class="td-sub">${clean(op.numero_factura)}</div>
                        </td>
                        <td>
                            <div class="td-main">${clean(op.rus)}</div>
                            <div class="td-sub">${clean(op.relator)}</div>
                        </td>
                        <td>
                            <span class="status-badge ${estadoClass}">${cap(clean(c.estado))}</span>
                        </td>
                        <td style="color: #d9480f; font-weight: 700; font-size: 0.8rem;">${nextSegDate}</td>
                        <td style="text-align: right;">
                            <div style="display: flex; gap: 8px; justify-content: flex-end;" onclick="event.stopPropagation()">
                                <a href="/api/seguimiento-page/" class="pill-btn" style="padding: 4px 10px; font-size: 0.7rem; background: #1e90ff; color: #fff;">Seguimiento</a>
                                <button class="pill-btn edit" onclick='editContrato(${c.id})'>&#x270E;</button>
                                <button class="pill-btn delete" onclick='deleteContrato(${c.id})'>&#x1F5D1;</button>
                            </div>
                        </td>
                    </tr>
                    <tr id="detail-${c.id}" class="detail-row" style="display: none;">
                        <td colspan="7">
                            <div class="detail-container">
                                <div style="display: grid; grid-template-columns: 1.2fr 1fr 1.5fr; gap: 20px;">
                                    <!-- Column 1: Detalles Operativos -->
                                    <div class="detail-section">
                                        <h4 style="font-size: 0.85rem; margin-bottom: 12px; color: #1e90ff; display: flex; align-items: center; gap: 8px;">
                                            Curso
                                        </h4>
                                        <div style="padding: 15px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                            <div style="font-weight: 700; color: var(--text-color); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; font-size: 0.9rem;">
                                                ${c.curso_nombre || 'Sin curso asignado'}
                                                <div style="font-size: 0.65rem; color: #1e90ff; font-weight: 400; margin-top: 6px; display: flex; align-items: center; gap: 8px;">
                                                    <span>SENCE: ${c.curso_codigo_sence && c.curso_codigo_sence !== '-' ? c.curso_codigo_sence : 'N/A'}</span>
                                                    <span style="width: 4px; height: 4px; background: var(--border-color); border-radius: 50%;"></span>
                                                    <span>Modalidad: <strong>${clean(op.modalidad)}</strong></span>
                                                </div>
                                            </div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.8rem;">
                                                <div><span style="color: var(--text-muted);">Fecha Inicio:</span> <br><strong>${clean(op.fecha_inicio_curso)}</strong></div>
                                                <div><span style="color: var(--text-muted);">Fecha Fin:</span> <br><strong>${clean(op.fecha_fin_curso)}</strong></div>
                                                <div><span style="color: var(--text-muted);">Duración:</span> <br><strong>${clean(op.duracion_horas)} Horas</strong></div>
                                                <div><span style="color: var(--text-muted);">Participantes:</span> <br><strong>${clean(op.numero_participantes)}</strong></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Column 2: Distribución Pagos -->
                                    <div class="detail-section">
                                        <h4 style="font-size: 0.85rem; margin-bottom: 12px; color: #1e90ff; display: flex; align-items: center; gap: 8px;">
                                            Distribución Pagos
                                        </h4>
                                        <div style="padding: 15px; background: rgba(30,144,255,0.02); border: 1px solid var(--border-color); border-radius: 12px; height: calc(100% - 30px);">
                                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 8px;">
                                                <span>Pago OTIC:</span>
                                                <span style="font-weight: 600;">${fmtCur(c.pago_otic)}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 8px;">
                                                <span>Pago Empresa:</span>
                                                <span style="font-weight: 600;">${fmtCur(c.pago_empresa)}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                                                <span>Total:</span>
                                                <strong style="color: #1e90ff;">${fmtCur(c.valor_total)}</strong>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Column 3: Asignación de Proveedores -->
                                    <div class="detail-section">
                                        <h4 style="font-size: 0.85rem; margin-bottom: 12px; color: #1e90ff; display: flex; align-items: center; gap: 8px;">
                                            Proveedores y Costos
                                        </h4>
                                        <div style="padding: 15px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; height: calc(100% - 30px);">
                                            ${c.contratoproveedor_set && c.contratoproveedor_set.length > 0 
                                                ? c.contratoproveedor_set.map(cp => `
                                                    <div style="padding: 8px; background: rgba(30,144,255,0.05); border-radius: 8px; margin-bottom: 6px; font-size: 0.75rem;">
                                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                                            <strong style="color: #1e90ff;">${cp.proveedor_nombre || 'Prov #' + cp.proveedor}</strong>
                                                            <span style="color: var(--text-muted);">${cp.servicio_nombre || 'Serv #' + cp.servicio}</span>
                                                        </div>
                                                        <div style="display: flex; justify-content: space-between;">
                                                            <span>Costo:</span>
                                                            <strong style="color: #e63946;">${fmtCur(cp.costo_negociado)}</strong>
                                                        </div>
                                                    </div>
                                                `).join('')
                                                : '<div style="text-align: center; padding: 15px; color: var(--text-muted); font-size: 0.75rem;">Sin proveedores asignados</div>'
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>

                    `}).join('');
            }
        } catch (error) { 
            console.error('Error loadContratos:', error);
            document.getElementById('loading').textContent = 'Error cargando datos'; 
        }
    }

    function editContrato(id) {
        const c = currentContratos.find(x => x.id === id);
        if (c) showForm(c);
    }

    async function loadEmpresas() {
        try {
            const response = await fetch('/api/clientes/');
            const data = await response.json();
            const select = document.getElementById('empresa-select');
            const items = Array.isArray(data) ? data : (data.results || []);
            items.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.textContent = e.razon_social;
                select.appendChild(opt);
            });
        } catch (error) { console.error('Error loading empresas'); }
    }

    async function loadServicios() {
        try {
            const response = await fetch('/api/servicios/');
            const data = await response.json();
            const select = document.getElementById('servicios-select');
            if (!select) return;
            select.innerHTML = '';
            const items = Array.isArray(data) ? data : (data.results || []);
            items.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.nombre;
                select.appendChild(opt);
            });
            // Siempre agregar 'Otros'
            const optOtros = document.createElement('option');
            optOtros.value = 'otros';
            optOtros.textContent = 'OTRO';
            optOtros.style.color = '#1e90ff';
            select.appendChild(optOtros);
        } catch (error) { console.error('Error loading servicios'); }
    }

    function checkOtrosServicio() {
        const select = document.getElementById('servicios-select');
        const container = document.getElementById('otro-servicio-container');
        const isOtrosSelected = Array.from(select.options).some(opt => opt.selected && opt.value === 'otros');
        container.style.display = isOtrosSelected ? 'block' : 'none';
        updateServiceCostRows();
    }

    async function loadProveedores() {
        try {
            const response = await fetch('/api/proveedores/');
            const data = await response.json();
            const select = document.getElementById('proveedores-select');
            const items = Array.isArray(data) ? data : (data.results || []);
            items.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.nombre;
                select.appendChild(opt);
            });
        } catch (error) { console.error('Error loading proveedores'); }
    }

    async function loadCursos() {
        try {
            const response = await fetch('/api/cursos/');
            const data = await response.json();
            const select = document.getElementById('curso-select');
            const items = Array.isArray(data) ? data : (data.results || []);
            items.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.codigo_sence && c.codigo_sence !== '-' 
                    ? `${c.nombre} (SENCE: ${c.codigo_sence})` 
                    : c.nombre;
                select.appendChild(opt);
            });
        } catch (error) { console.error('Error loading cursos'); }
    }

    async function loadEjecutivos() {
        try {
            const response = await fetch('/api/ejecutivos/');
            const data = await response.json();
            const select = document.getElementById('ejecutivo-select');
            const items = Array.isArray(data) ? data : (data.results || []);
            select.innerHTML = '<option value="">No asignado</option>';
            items.forEach(ej => {
                const opt = document.createElement('option');
                opt.value = ej.id;
                opt.textContent = ej.nombre;
                select.appendChild(opt);
            });
        } catch (error) { console.error('Error loading ejecutivos'); }
    }

    let allCoordinators = [];
    async function loadEncargados() {
        try {
            const response = await fetch('/api/coordinadores/');
            const data = await response.json();
            allCoordinators = Array.isArray(data) ? data : (data.results || []);
            renderEncargadosDropdown();
        } catch (error) { console.error('Error loading encargados'); }
    }

    function renderEncargadosDropdown(clientId = null) {
        const select = document.getElementById('encargado-select');
        if (!select) return;
        select.innerHTML = '<option value="">No asignado</option>';
        
        const filtered = clientId 
            ? allCoordinators.filter(c => c.cliente === parseInt(clientId))
            : allCoordinators;

        filtered.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.nombre;
            select.appendChild(opt);
        });
    }

    let allClientes = [];
    async function loadEmpresas() {
        try {
            const response = await fetch('/api/clientes/');
            const data = await response.json();
            allClientes = Array.isArray(data) ? data : (data.results || []);
            const select = document.getElementById('empresa-select');
            select.innerHTML = '<option value="">Seleccionar empresa...</option>';
            allClientes.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.textContent = e.nombre; // Usamos Nombre de Fantasía
                select.appendChild(opt);
            });
        } catch (error) { console.error('Error loading empresas'); }
    }

    document.getElementById('empresa-select').addEventListener('change', function() {
        const clientId = this.value;
        const warning = document.getElementById('razon-social-warning');
        
        if (!clientId) {
            renderEncargadosDropdown();
            warning.style.display = 'none';
            return;
        }
        
        // Check for razon social
        const client = allClientes.find(c => c.id == clientId);
        if (client && (!client.razon_social || client.razon_social.toString().toLowerCase() === 'nan')) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
        
        // Filter the coordinator list to show only those belonging to the selected client
        renderEncargadosDropdown(clientId);
    });
    async function saveContrato(e) {
        e.preventDefault();
        const form = e.target;
        const id = document.getElementById('contrato-id').value;

        const body = {
            cliente: parseInt(form.empresa.value),
            ejecutivo: parseInt(form.ejecutivo.value),
            coordinador: parseInt(form.coordinador.value),
            estado: form.estado.value,
            tipo_convenio: form.tipo_convenio.value,
            curso: form.curso.value ? parseInt(form.curso.value) : null,
            servicios: Array.from(document.getElementById('servicios-select').options)
                        .filter(opt => opt.selected && opt.value !== 'otros')
                        .map(opt => parseInt(opt.value)),
            otro_servicio: document.getElementById('form-otro_servicio').value,
            operativo_data: {
                orden_compra: form.orden_compra.value,
                numero_factura: form.numero_factura.value,
                rus: form.rus.value,
                relator: form.relator.value,
                modalidad: form.modalidad.value,
                fecha_inicio_curso: form.fecha_inicio_curso.value || null,
                fecha_fin_curso: form.fecha_fin_curso.value || null,
                duracion_horas: parseInt(form.duracion_horas.value) || 0,
                numero_participantes: parseInt(form.numero_participantes.value) || 0,
                tipo_curso: 'SENCE'
            },
            proveedores_data: Array.from(document.querySelectorAll('.service-cost-row')).map(row => ({
                servicio: parseInt(row.dataset.servicioId),
                proveedor: row.querySelector('.prov-sel').value === 'otros' ? 'otros' : (row.querySelector('.prov-sel').value ? parseInt(row.querySelector('.prov-sel').value) : null),
                otro_proveedor: row.querySelector('.otro-prov-inp').value,
                costo_negociado: parseFloat(row.querySelector('.cost-inp').value) || 0
            })).filter(item => item.proveedor !== null || (item.proveedor === 'otros' && item.otro_proveedor))
        };

        try {
            const url = id ? `/api/contratos/${id}/` : '/api/contratos/';
            const method = id ? 'PATCH' : 'POST';
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(body)
            });
            if (response.ok) {
                showAlert(id ? 'Contrato actualizado' : 'Contrato creado', 'success');
                hideForm();
                loadContratos();
            } else { 
                const err = await response.json();
                showAlert('Error: ' + JSON.stringify(err), 'error'); 
            }
        } catch (error) { showAlert('Error de conexion', 'error'); }
    }

    async function deleteContrato(id) {
        if (!confirm('¿Está seguro de eliminar este contrato? Esta acción no se puede deshacer.')) return;
        try {
            const response = await fetch(`/api/contratos/${id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            if (response.ok) {
                showAlert('Contrato eliminado correctamente', 'success');
                loadContratos();
            } else {
                showAlert('Error al eliminar contrato.', 'error');
            }
        } catch (error) {
            showAlert('Error de conexión con el servidor', 'error');
        }
    }

    function showAlert(message, type) {
        const alert = document.getElementById('alert');
        alert.textContent = message;
        alert.style.display = 'block';
        alert.style.background = type === 'success' ? 'rgba(16, 185, 129, 0.2)' : 'rgba(255,0,0,0.2)';
        setTimeout(() => { alert.style.display = 'none'; }, 5000);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    loadContratos();
    loadEmpresas();
    loadServicios();
    loadProveedores();
    loadCursos();
    loadEjecutivos();
    loadEncargados();
</script>
{% endblock %}
