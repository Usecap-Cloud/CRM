{% extends 'base.html' %}

{% block title %}Importar Datos - USECAP CRM{% endblock %}
{% block nav_importar %}active{% endblock %}

{% block extra_styles %}
<style>
    /* Premium Import Styles */
    .import-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .import-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 24px;
        padding: 40px;
        backdrop-filter: blur(12px);
        margin-bottom: 24px;
    }

    .drop-zone {
        border: 2px dashed rgba(30, 144, 255, 0.3);
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: rgba(30, 144, 255, 0.02);
        margin-bottom: 20px;
    }

    .drop-zone:hover,
    .drop-zone.active {
        background: rgba(30, 144, 255, 0.08);
        border-color: #1e90ff;
    }

    .drop-zone i {
        font-size: 3rem;
        color: #1e90ff;
        margin-bottom: 15px;
        display: block;
    }

    .btn-import {
        background: #1e90ff;
        color: #fff;
        border: none;
        padding: 14px 40px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        font-size: 1rem;
        transition: transform 0.3s, background 0.3s;
        margin-top: 20px;
        width: 100%;
        box-shadow: 0 4px 15px rgba(30, 144, 255, 0.3);
    }

    .btn-import:hover {
        background: #007bff;
        transform: translateY(-2px);
    }

    .status-msg {
        margin-top: 20px;
        padding: 20px;
        border-radius: 12px;
        display: none;
        word-break: break-word;
        line-height: 1.5;
    }

    .status-msg.success {
        background: var(--success-green-bg);
        color: var(--success-green);
        border: 1px solid var(--success-green);
    }
    .status-msg.error {
        background: rgba(255, 107, 107, 0.1);
        color: #ff6b6b;
        border: 1px solid rgba(255, 107, 107, 0.2);
    }

    .select-group {
        margin-bottom: 25px;
    }

    .select-group label {
        display: block;
        margin-bottom: 10px;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .premium-select {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 12px 16px;
        color: var(--text-color);
        width: 100%;
        outline: none;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-title">
        <h1>Importaci√≥n Universal</h1>
    </div>
    <div class="page-actions"></div>
</div>

<div class="import-container">
    <div class="import-card">
        <div class="select-group">
            <label>Tipo de Datos a Cargar</label>
            <select id="model-type" class="premium-select">
                        <option value="cliente">Clientes (Empresas)</option>
                        <option value="coordinador">Encargados (Contactos)</option>
                        <option value="propuesta">Propuestas Comerciales</option>
                        <option value="contrato">Contratos Operativos</option>
                        <option value="ejecutivo">Ejecutivos</option>
                        <option value="proveedor">Proveedores</option>
                        <option value="curso">Cursos</option>
                        <option value="servicio">Servicios</option>
            </select>
        </div>

        <div class="drop-zone" onclick="document.getElementById('file-input').click()" id="drop-zone">
            <i>&#x1F4E4;</i>
            <p style="font-weight: 600; color: var(--text-color);">Arrastre su archivo Excel aqu√≠</p>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">o haga clic para seleccionar</p>
            <input type="file" id="file-input" style="display: none;" accept=".xlsx, .xls">
        </div>

        <div id="file-name"
            style="margin-top: 15px; font-size: 0.85rem; color: #1e90ff; display: none; text-align: center; font-weight: 600;">
        </div>

        <button class="btn-import" onclick="uploadFile()">Ejecutar Importaci√≥n</button>

        <div id="status-msg" class="status-msg"></div>
    </div>

    <div class="import-card" style="opacity: 0.9; border-color: rgba(30, 144, 255, 0.2);">
        <h3 style="margin-bottom: 15px; color: #1e90ff;">üí° Tips de Formato</h3>
        <ul style="color: #aaa; font-size: 0.85rem; list-style: none; padding: 0; line-height: 1.6;">
            <li><strong>RUTs:</strong> Deben incluir d√≠gito verificador.</li>
            <li><strong>Tel√©fonos:</strong> Use solo n√∫meros, <code>+</code>.</li>
            <li><strong>Clientes:</strong> Requiere RUT de la empresa y raz√≥n social (nombre completo).</li>
            <li><strong>Ejecutivos:</strong> Requiere datos personales, rol y <code>departamento</code>.</li>
            <li><strong>Encargados:</strong> Requiere vinculaci√≥n con cliente v√≠a RUT, <code>cargo</code> y <code>departamento</code>.</li>
            <li><strong>Importante:</strong> El sistema detectar√° duplicados y te avisar√° en qu√© fila est√°n.</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileName = document.getElementById('file-name');
    const statusMsg = document.getElementById('status-msg');

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('active');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('active');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');
        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            updateFileName();
        }
    });

    fileInput.addEventListener('change', updateFileName);

    function updateFileName() {
        if (fileInput.files.length) {
            fileName.textContent = 'Archivo seleccionado: ' + fileInput.files[0].name;
            fileName.style.display = 'block';
        }
    }

    async function uploadFile() {
        if (!fileInput.files.length) {
            showStatus('Por favor, seleccione un archivo primero.', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('model_type', document.getElementById('model-type').value);

        showStatus('Procesando archivo... Espere un momento.', 'success');

        try {
            const response = await fetch('/api/importar-universal/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });

            const result = await response.json().catch(() => ({}));

            if (response.ok) {
                let msg = `<strong>${result.message}</strong>`;
                if (result.errors && result.errors.length > 0) {
                    msg += `<br><br><div style="text-align: left; font-size: 0.9rem;">
                                <strong style="color: #ffcc00;">Observaciones/Alertas (${result.errors.length}):</strong>
                                <ul style="margin: 10px 0 0 20px; max-height: 200px; overflow-y: auto;">
                                    ${result.errors.map(e => `<li>${e}</li>`).join('')}
                                </ul>
                            </div>`;
                }
                showStatus(msg, 'success');
            } else {
                let err = result.error || 'No se pudo procesar el archivo';
                if (result.errors && result.errors.length > 0) {
                    err = `<strong>Errores encontrados (${result.errors.length}):</strong>
                          <ul style="margin: 10px 0 0 20px; text-align: left; font-size: 0.9rem;">
                              ${result.errors.map(e => `<li>${e}</li>`).join('')}
                          </ul>`;
                }
                if (result.cols_detected) {
                    err += '<br><br><strong>Columnas encontradas en el archivo:</strong><br>' + result.cols_detected.join(', ');
                }
                showStatus(err, 'error');
            }
        } catch (error) {
            showStatus('Error de conexi√≥n con el servidor. Reintente.', 'error');
        }
    }

    function showStatus(msg, type) {
        statusMsg.innerHTML = msg;
        statusMsg.className = 'status-msg ' + type;
        statusMsg.style.display = 'block';
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
