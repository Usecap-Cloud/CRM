{% extends 'base.html' %}

{% block title %}Seguimiento - USECAP CRM{% endblock %}
{% block nav_seguimiento %}active{% endblock %}

{% block extra_styles %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/es.js'></script>

<style>
    .seguimiento-container {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 20px;
        height: calc(100vh - 120px);
    }

    #calendar-card {
        padding: 0;
        height: 100%;
        /* No background or border as requested */
    }

    .fc {
        color: var(--text-color);
    }

    .fc-header-toolbar {
        display: grid !important;
        grid-template-columns: 1fr auto 1fr !important;
        align-items: center !important;
        margin-bottom: 2rem !important;
    }

    .fc-toolbar-chunk:nth-child(2) {
        text-align: center;
    }

    .fc-toolbar-chunk:nth-child(3) {
        display: flex;
        justify-content: flex-end;
    }

    .fc-toolbar-title {
        color: #1e90ff !important;
        font-size: 1.2rem !important;
        text-transform: capitalize;
    }

    /* pill-style buttons */
    .fc-button-group {
        background: var(--card-bg);
        border: 1px solid var(--border-color) !important;
        border-radius: 25px !important;
        padding: 4px !important;
        display: inline-flex !important;
        align-items: center !important;
        margin-right: 15px !important;
    }

    .fc-button {
        background: transparent !important;
        border: none !important;
        color: var(--text-muted) !important;
        padding: 12px 32px !important;
        border-radius: 20px !important;
        cursor: pointer !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
        font-size: 1rem !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        height: auto !important;
        box-shadow: none !important;
        margin: 0 !important;
    }

    .fc-button-primary:hover,
    .fc-button-primary.fc-button-active {
        background-color: #1e90ff !important;
        color: #fff !important;
        box-shadow: 0 4px 15px rgba(30, 144, 255, 0.3) !important;
    }

    .fc-button-active {
        background-color: #1e90ff !important;
        color: #fff !important;
    }

    /* Fix arrows centering */
    .fc .fc-icon {
        font-size: 1.2em !important;
        vertical-align: middle !important;
    }

    .fc-daygrid-day:hover {
        background: rgba(30, 144, 255, 0.05);
    }

    #alerts-panel {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 20px;
        overflow-y: auto;
    }

    .panel-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #ff9f43;
    }

    .alert-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-left: 4px solid #ff9f43;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 12px;
        font-size: 0.85rem;
    }


    .alert-card.urgent {
        border-left-color: #ff6b6b;
    }

    .alert-card.closure {
        border-left-color: var(--success-green);
    }

    .alert-date {
        color: var(--text-muted);
        font-size: 0.75rem;
        margin-bottom: 4px;
    }

    .alert-desc {
        font-weight: 500;
        color: var(--text-color);
    }

    .alert-link {
        color: #1e90ff;
        text-decoration: none;
        font-size: 0.75rem;
        margin-top: 6px;
        display: inline-block;
    }

    /* More prominent grid borders */
    .fc-theme-standard td,
    .fc-theme-standard th,
    .fc-scrollgrid {
        border: 1px solid var(--border-color) !important;
    }

    /* Aggressive fix for white background in headers */
    .fc-scrollgrid-section-header,
    .fc-scrollgrid-section-header th,
    .fc-scrollgrid-section-header td,
    .fc-col-header,
    .fc-col-header-cell {
        background: var(--card-bg) !important;
        background-color: var(--card-bg) !important;
    }

    .fc-col-header-cell-cushion {
        color: var(--text-color) !important;
        text-decoration: none !important;
        font-weight: 600 !important;
        text-transform: capitalize;
        display: block;
        padding: 12px 0 !important;
    }

    .fc-daygrid-day-number {
        color: var(--text-color) !important;
        padding: 8px !important;
        font-weight: 500;
        text-decoration: none !important;
    }

    .fc-day-today {
        background: rgba(30, 144, 255, 0.1) !important;
    }

    /* Executive Selector styled like a button but with original theme colors */
    .pill-selector {
        background: var(--card-bg) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-color) !important;
        padding: 12px 40px 12px 24px !important; /* Added right padding for the arrow */
        border-radius: 30px !important;
        font-weight: 600 !important;
        font-size: 0.9rem !important;
        cursor: pointer !important;
        outline: none !important;
        appearance: none;
        -webkit-appearance: none;
        text-align: left;
        transition: all 0.3s ease;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: right 15px center !important;
    }

    .pill-selector:hover {
        border-color: #1e90ff !important;
    }
    
    .fc-col-header {
        background: rgba(255, 255, 255, 0.03) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="seguimiento-container">
    <div style="display: flex; flex-direction: column; gap: 20px;">
        <div class="page-header" style="text-align: center; margin-bottom: 0;">
            <div class="header-title" style="display: flex; flex-direction: column; align-items: center; width: 100%;">
                <h1 style="margin-bottom: 10px;">Centro de Seguimiento</h1>
                
                <div style="display: flex; gap: 15px; align-items: center; justify-content: center;">
                    {% if user.is_superuser or user.ejecutivo.rol.nombre == 'Administrador' or user.ejecutivo.rol.nombre == 'Gerencia' %}
                    <div class="filter-group">
                        <select id="ejecutivo-filter" class="pill-selector">
                            <option value="">Todos los Ejecutivos</option>
                        </select>
                    </div>
                    {% endif %}
                    <button class="pill-btn primary" onclick="openNewSegModal()"><span>&#x002B;</span> Nueva Acción</button>
                </div>
            </div>
        </div>

        <div id="calendar-card">
            <div id="calendar"></div>
        </div>
    </div>

    <div id="alerts-panel" style="margin-top: 65px;">
        <div class="panel-title">
            <span>&#x26A0;</span> Alertas Próximas
        </div>
        <div id="alerts-list">
            <div style="color: #888; text-align: center; padding: 20px;">Cargando alertas...</div>
        </div>
    </div>
</div>

<!-- Simple Modal for New Seguimiento -->
<div id="new-seg-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; width: 500px; padding: 30px; position: relative;">
        <button onclick="closeModal()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer;">&times;</button>
        <h2 style="margin-bottom: 25px;">Registrar Acción</h2>
        
        <form id="new-seg-form" onsubmit="saveNewSeguimiento(event)">
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div class="form-group">
                    <label style="font-size: 0.85rem; color: #888; margin-bottom: 5px; display: block;">Contrato (Folio)</label>
                    <select id="modal-contrato" required style="width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; border-radius: 10px;">
                        <option value="">Seleccionar Contrato...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="font-size: 0.85rem; color: #888; margin-bottom: 5px; display: block;">Tipo / Acción</label>
                    <input type="text" id="modal-tipo" placeholder="Llamada, Visita, Correo..." required style="width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; border-radius: 10px;">
                </div>
                <div class="form-row" style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label style="font-size: 0.85rem; color: #888; margin-bottom: 5px; display: block;">Fecha Registro</label>
                        <input type="date" id="modal-fecha" required style="width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; border-radius: 10px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label style="font-size: 0.85rem; color: #888; margin-bottom: 5px; display: block;">Próximo Seguimiento</label>
                        <input type="date" id="modal-fecha-seguimiento" style="width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; border-radius: 10px;">
                    </div>
                </div>
                <div class="form-group">
                    <label style="font-size: 0.85rem; color: #888; margin-bottom: 5px; display: block;">Solicitud / Requerimiento</label>
                    <textarea id="modal-req" style="width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; border-radius: 10px; height: 80px;"></textarea>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                    <button type="button" onclick="closeModal()" class="pill-btn" style="background: rgba(255,255,255,0.05);">Cancelar</button>
                    <button type="submit" class="pill-btn primary">Guardar Acción</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let calendar;
    let allContratos = [];

    document.addEventListener('DOMContentLoaded', async function () {
        const calendarEl = document.getElementById('calendar');
        
        // Load filter options if allowed
        const filterEl = document.getElementById('ejecutivo-filter');
        if (filterEl) {
            try {
                const res = await fetch('/api/ejecutivos/');
                const data = await res.json();
                const items = Array.isArray(data) ? data : (data.results || []);
                items.forEach(ej => {
                    const opt = document.createElement('option');
                    opt.value = ej.id;
                    opt.textContent = ej.nombre;
                    filterEl.appendChild(opt);
                });
                
                filterEl.addEventListener('change', () => loadCalendarData());
            } catch (e) { console.error('Error loading filter options'); }
        }

        // Initialize Calendar once
        calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'es',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek'
            },
            titleFormat: { year: 'numeric', month: 'long' },
            themeSystem: 'standard',
            height: 'auto',
            events: [],
            eventClick: function (info) {
                console.log('Event Clicked:', info.event.extendedProps);
            }
        });
        calendar.render();

        // Initial Data Load
        loadCalendarData();
        loadAllContratos();
    });

    async function loadAllContratos() {
        try {
            const res = await fetch('/api/contratos/');
            allContratos = await res.json();
            
            const modalSelect = document.getElementById('modal-contrato');
            allContratos.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = `${c.folio} - ${c.empresa_nombre}`;
                modalSelect.appendChild(opt);
            });
        } catch (e) { console.error('Error loading contracts'); }
    }

    async function loadCalendarData() {
        try {
            const filterEl = document.getElementById('ejecutivo-filter');
            const ejecutivoId = filterEl ? filterEl.value : '';
            const url = `/api/seguimientos/${ejecutivoId ? '?ejecutivo=' + ejecutivoId : ''}`;

            const [seguimientos, contratos] = await Promise.all([
                fetch(url).then(r => r.json()),
                fetch('/api/contratos/').then(r => r.json())
            ]);

            const events = [];
            const todayStr = new Date().toISOString().split('T')[0];
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            seguimientos.forEach(s => {
                let eventColor = '#1e90ff';
                if (s.cerrado) {
                    eventColor = '#444';
                } else {
                    const eventDate = s.fecha_seguimiento || s.fecha;
                    if (eventDate < todayStr) eventColor = '#ff6b6b';
                    else if (eventDate === todayStr || eventDate === tomorrowStr) eventColor = '#ff9f43';
                }

                events.push({
                    title: 'Acción: ' + s.tipo,
                    start: s.fecha,
                    color: s.cerrado ? '#444' : eventColor,
                    extendedProps: { type: 'seguimiento', id: s.id }
                });

                if (s.fecha_seguimiento) {
                    events.push({
                        title: 'Prox Acción: ' + s.tipo,
                        start: s.fecha_seguimiento,
                        color: s.cerrado ? '#444' : eventColor,
                        extendedProps: { type: 'proxima', id: s.id }
                    });
                }
            });

            // If not filtering by a specific executive, show emittances
            if (!ejecutivoId) {
                contratos.forEach(c => {
                    if (c.fecha_emision) {
                        events.push({
                            title: 'Emisión Contrato: ' + c.empresa_nombre,
                            start: c.fecha_emision,
                            color: '#059669',
                            extendedProps: { type: 'contrato_emision', id: c.id }
                        });
                    }
                });
            }

            calendar.removeAllEvents();
            calendar.addEventSource(events);
            
            updateAlerts(seguimientos, contratos);
        } catch (e) { console.error('Error loading calendar data'); }
    }

    function updateAlerts(seguimientos, contratos) {
        const alertsList = document.getElementById('alerts-list');
        alertsList.innerHTML = '';

        const today = new Date();
        const nextWeek = new Date();
        nextWeek.setDate(today.getDate() + 7);

        const imminentActions = seguimientos.filter(s => {
            if (!s.fecha_seguimiento || s.cerrado) return false;
            const d = new Date(s.fecha_seguimiento);
            return d >= today && d <= nextWeek;
        });

        const imminentClosures = contratos.filter(c => c.estado && (c.estado.toLowerCase().includes('por cerrar') || c.estado.toLowerCase().includes('activo')));

        if (imminentActions.length === 0 && imminentClosures.length === 0) {
            alertsList.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No hay alertas pendientes para los próximos 7 días</div>';
        }

        imminentActions.forEach(s => {
            const card = document.createElement('div');
            card.className = 'alert-card urgent';
            card.innerHTML = `
                <div class="alert-date">Próxima acción: ${s.fecha_seguimiento}</div>
                <div class="alert-desc">${s.tipo} - ${s.empresa_nombre}</div>
                <a href="/api/contratos-page/" class="alert-link">Ver Contrato</a>
            `;
            alertsList.appendChild(card);
        });
    }

    function openNewSegModal() {
        document.getElementById('new-seg-modal').style.display = 'flex';
        document.getElementById('modal-fecha').value = new Date().toISOString().split('T')[0];
    }

    function closeModal() {
        document.getElementById('new-seg-modal').style.display = 'none';
        document.getElementById('new-seg-form').reset();
    }

    async function saveNewSeguimiento(e) {
        e.preventDefault();
        const contrattoId = document.getElementById('modal-contrato').value;
        const contrato = allContratos.find(c => c.id == contrattoId);
        
        const data = {
            contrato: contrattoId,
            tipo: document.getElementById('modal-tipo').value,
            fecha: document.getElementById('modal-fecha').value,
            fecha_seguimiento: document.getElementById('modal-fecha-seguimiento').value || null,
            requerimiento: document.getElementById('modal-req').value,
            estado: 'Pendiente',
            cerrado: false,
            ejecutivo: contrato ? contrato.ejecutivo : null,
            coordinador: contrato ? contrato.coordinador : null,
            cliente: contrato ? contrato.cliente : null
        };

        try {
            const res = await fetch('/api/seguimientos/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                closeModal();
                loadCalendarData();
                Swal.fire('Guardado', 'La acción ha sido registrada', 'success');
            } else {
                const err = await res.json();
                Swal.fire('Error', JSON.stringify(err), 'error');
            }
        } catch (e) { Swal.fire('Error', 'Error de conexión', 'error'); }
    }
</script>
{% endblock %}
